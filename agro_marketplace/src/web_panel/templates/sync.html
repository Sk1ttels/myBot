{% extends "base.html" %}

{% block title %}Синхронізація{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i class="bi bi-arrow-repeat"></i> Статус синхронізації
        </h2>
        <button class="btn btn-primary" onclick="location.reload()">
            <i class="bi bi-arrow-clockwise"></i> Оновити
        </button>
    </div>

    <!-- Sync Statistics -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-clock-history"></i> Необроблені події
                    </h5>
                    <h2 class="text-primary">{{ unprocessed_events|length }}</h2>
                    <p class="text-muted mb-0">Очікують обробки ботом</p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-check-circle"></i> Оброблені події
                    </h5>
                    <h2 class="text-success">{{ total_processed }}</h2>
                    <p class="text-muted mb-0">Успішно синхронізовано</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Sync Status -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-info-circle"></i> Інформація про синхронізацію
            </h5>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <h6><i class="bi bi-lightbulb"></i> Як працює синхронізація:</h6>
                <ul class="mb-0">
                    <li>Веб-панель записує події (бан, розбан, зміна статусу) у файл синхронізації</li>
                    <li>Telegram бот кожні 2 секунди перевіряє нові події</li>
                    <li>Користувачі отримують сповіщення про зміни в реальному часі</li>
                    <li>Синхронізація працює автоматично, коли бот запущений</li>
                </ul>
            </div>

            <div class="mt-3">
                <h6>Типи подій:</h6>
                <div class="row">
                    <div class="col-md-3">
                        <span class="badge bg-danger">user_banned</span>
                        <p class="small text-muted">Блокування користувача</p>
                    </div>
                    <div class="col-md-3">
                        <span class="badge bg-success">user_unbanned</span>
                        <p class="small text-muted">Розблокування користувача</p>
                    </div>
                    <div class="col-md-3">
                        <span class="badge bg-warning">lot_status_changed</span>
                        <p class="small text-muted">Зміна статусу лота</p>
                    </div>
                    <div class="col-md-3">
                        <span class="badge bg-info">settings_changed</span>
                        <p class="small text-muted">Зміна налаштувань</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Unprocessed Events List -->
    {% if unprocessed_events %}
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-list-task"></i> Необроблені події
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Час</th>
                            <th>Тип події</th>
                            <th>Дані</th>
                            <th>Статус</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for event in unprocessed_events %}
                        <tr>
                            <td>
                                <small>{{ event.timestamp }}</small>
                            </td>
                            <td>
                                {% if event.event_type == 'user_banned' %}
                                    <span class="badge bg-danger">{{ event.event_type }}</span>
                                {% elif event.event_type == 'user_unbanned' %}
                                    <span class="badge bg-success">{{ event.event_type }}</span>
                                {% elif event.event_type == 'lot_status_changed' %}
                                    <span class="badge bg-warning">{{ event.event_type }}</span>
                                {% elif event.event_type == 'settings_changed' %}
                                    <span class="badge bg-info">{{ event.event_type }}</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ event.event_type }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <code style="font-size: 0.85rem;">
                                    {% if event.data.user_id %}
                                        User ID: {{ event.data.user_id }}
                                    {% endif %}
                                    {% if event.data.telegram_id %}
                                        | TG ID: {{ event.data.telegram_id }}
                                    {% endif %}
                                    {% if event.data.lot_id %}
                                        Lot ID: {{ event.data.lot_id }}
                                    {% endif %}
                                    {% if event.data.new_status %}
                                        | Status: {{ event.data.new_status }}
                                    {% endif %}
                                </code>
                            </td>
                            <td>
                                <span class="badge bg-warning">Очікує</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-success">
        <i class="bi bi-check-circle"></i> Всі події оброблено. Немає подій в черзі.
    </div>
    {% endif %}

    <!-- Instructions -->
    <div class="card mt-4">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0">
                <i class="bi bi-terminal"></i> Інструкції по використанню
            </h5>
        </div>
        <div class="card-body">
            <h6>Запуск синхронізованої версії бота:</h6>
            <pre class="bg-light p-3 rounded"><code>python src/bot_sync.py</code></pre>

            <h6 class="mt-3">Запуск веб-панелі з синхронізацією:</h6>
            <pre class="bg-light p-3 rounded"><code>python -m src.web_panel.app_sync</code></pre>

            <div class="alert alert-warning mt-3">
                <i class="bi bi-exclamation-triangle"></i> 
                <strong>Важливо:</strong> Для роботи синхронізації необхідно, щоб Telegram бот був запущений.
                Без запущеного бота події будуть накопичуватися, але сповіщення не будуть надсилатися.
            </div>
        </div>
    </div>
</div>

<style>
.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
    margin-bottom: 1rem;
}

.badge {
    font-size: 0.85rem;
    padding: 0.35em 0.65em;
}

code {
    background-color: #f8f9fa;
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
}

pre code {
    background-color: transparent;
    padding: 0;
}
</style>

<script>
// Auto-refresh every 10 seconds
setTimeout(function() {
    location.reload();
}, 10000);
</script>
{% endblock %}
